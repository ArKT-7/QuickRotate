name: Build QuickRotate

on:
  push:
    branches:
      - main
    paths:
      - 'QuickRotate.cpp'
      - 'QuickRotate.rc'
      - 'icon.ico'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW32
          install: mingw-w64-i686-gcc
          update: true

      - name: Compile Resources
        shell: msys2 {0}
        run: windres QuickRotate.rc -O coff -o QuickRotate_res.o

      - name: Compile Optimized Exe
        shell: msys2 {0}
        run: |
          g++ QuickRotate.cpp QuickRotate_res.o -o QuickRotate.exe -static -nostartfiles -e _WinMain@16 -Os -s -fno-exceptions -fno-rtti -fno-stack-protector -fomit-frame-pointer "-Wl,--gc-sections" -lgdi32 -luser32 -lgdiplus -lshlwapi -lshell32 -lole32 -luuid -ladvapi32 -mwindows

      - name: Restore Signing Certificate
        shell: pwsh
        env:
          CERT_BASE64: ${{ secrets.SIGNING_CERT }}
        run: |
          $certBytes = [System.Convert]::FromBase64String($env:CERT_BASE64)
          [System.IO.File]::WriteAllBytes("certificate.pfx", $certBytes)

      - name: Sign QuickRotate
        shell: pwsh
        env:
          CERT_PASS: ${{ secrets.SIGNING_PASS }}
        run: |
          Copy-Item "QuickRotate.exe" -Destination "QuickRotate_Signed.exe"
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Recurse -Filter "signtool.exe" | Select-Object -First 1
          if (-not $signtool) { Write-Error "Signtool not found!"; exit 1 }
          & $signtool.FullName sign /f "certificate.pfx" /p "$env:CERT_PASS" /fd SHA256 /d "Quick Rotate by ArKT-7" /du "https://github.com/ArKT-7" /t http://timestamp.sectigo.com "QuickRotate_Signed.exe"
          Remove-Item "certificate.pfx" -Force

      - name: Get Version & Date
        id: info
        shell: pwsh
        run: |
          $rcContent = Get-Content QuickRotate.rc
          $verLine = $rcContent | Select-String "FILEVERSION" | Select-Object -First 1
          $fullVer = $verLine.ToString().Replace("FILEVERSION", "").Trim().Replace(",", ".")
          $parts = $fullVer.Split('.')
          $shortVer = "$($parts[0]).$($parts[1]).$($parts[2])"
          echo "APP_VERSION=$shortVer" >> $env:GITHUB_ENV
          
          $date = (Get-Date).ToUniversalTime().ToString("d MMMM yyyy")
          $time = (Get-Date).ToUniversalTime().ToString("HH:mm 'UTC'")
          echo "BUILD_DATE=$date" >> $env:GITHUB_ENV
          echo "BUILD_TIME=$time" >> $env:GITHUB_ENV

      - name: Generate Release Notes
        shell: pwsh
        run: |
          $repo = "${{ github.repository }}"
          $ver = "${{ env.APP_VERSION }}"
          
          $body = @"
          ## ‚ö° Quick Rotate v$ver

          - **Build Date:** ``${{ env.BUILD_DATE }}``
          - **Build Time:** ``${{ env.BUILD_TIME }}``

          ---

          ### üì¶ Downloads

          - [**``QuickRotate.exe``**](https://github.com/$repo/releases/download/v$ver/QuickRotate.exe)
          - [**``QuickRotate_signed.exe``**](https://github.com/$repo/releases/download/v$ver/QuickRotate_Signed.exe)

          ---

          ### üöÄ Usage & Info

          - [**``Open Readme and read üôÇ‚Äç‚ÜîÔ∏è``**](https://github.com/$repo/blob/main/README.md#-usage-guide)
          "@
          
          [System.IO.File]::WriteAllText("release_notes.md", $body)

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.APP_VERSION }}
          name: Quick Rotate v${{ env.APP_VERSION }}
          body_path: release_notes.md
          files: |
            QuickRotate.exe
            QuickRotate_Signed.exe
